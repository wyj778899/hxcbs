<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chinaPress.fc.order.dao.FcOrderMapper">
	<resultMap id="BaseResultMap"
		type="chinaPress.fc.order.model.FcOrder">
		<id column="id" jdbcType="INTEGER" property="id" />
		<result column="date" jdbcType="DATE" property="date" />
		<result column="code" jdbcType="VARCHAR" property="code" />
		<result column="role_type" jdbcType="INTEGER"
			property="roleType" />
		<result column="role_id" jdbcType="INTEGER" property="roleId" />
		<result column="course_id" jdbcType="INTEGER"
			property="courseId" />
		<result column="start_time" jdbcType="TIMESTAMP"
			property="startTime" />
		<result column="end_time" jdbcType="TIMESTAMP"
			property="endTime" />
		<result column="is_coupon" jdbcType="INTEGER"
			property="isCoupon" />
		<result column="coupon_id" jdbcType="INTEGER"
			property="couponId" />
		<result column="pay_status" jdbcType="INTEGER"
			property="payStatus" />
		<result column="state" jdbcType="INTEGER" property="state" />
		<result column="create_id" jdbcType="INTEGER"
			property="createId" />
		<result column="create_time" jdbcType="TIMESTAMP"
			property="createTime" />
		<result column="update_id" jdbcType="INTEGER"
			property="updateId" />
		<result column="update_time" jdbcType="TIMESTAMP"
			property="updateTime" />
		<result column="is_individual" jdbcType="INTEGER"
			property="isIndividual" />
		<result column="order_amount" jdbcType="DECIMAL"
			property="orderAmount" />
		<result column="discount_amount" jdbcType="DECIMAL"
			property="discountAmount" />
		<result column="pay_amount" jdbcType="DECIMAL"
			property="payAmount" />
		<result column="apply_id" jdbcType="INTEGER" property="applyId" />


		<result column="invoice_type" jdbcType="INTEGER"
			property="invoiceType" />
		<result column="invoice_title" jdbcType="VARCHAR"
			property="invoiceTitle" />
		<result column="invoice_number" jdbcType="VARCHAR"
			property="invoiceNumber" />
		<result column="invoice_details" jdbcType="VARCHAR"
			property="invoiceDetails" />
		<result column="consignee_name" jdbcType="VARCHAR"
			property="consigneeName" />
		<result column="consignee_area" jdbcType="VARCHAR"
			property="consigneeArea" />
		<result column="consignee_address" jdbcType="VARCHAR"
			property="consigneeAddress" />
		<result column="consignee_phone" jdbcType="VARCHAR"
			property="consigneePhone" />
		<result column="payment_mode" jdbcType="VARCHAR"
			property="paymentMode" />
		<result column="third_party_no" jdbcType="VARCHAR"
			property="thirdPartyNo" />
		<!-- 20200713  wyj add -->
		<result column="bank_deposit" jdbcType="VARCHAR"
			property="bankDeposit" />
		<result column="bank_number" jdbcType="VARCHAR"
			property="bankNumber" />
		<result column="remarks" jdbcType="VARCHAR"
			property="remarks" />
		<result column="email" jdbcType="VARCHAR"
		property="email" />
		<result column="invoice_state" jdbcType="INTEGER"
		property="invoiceState" />
	</resultMap>
	<sql id="Base_Column_List">
		id, `date`, code, role_type, role_id, course_id, start_time, end_time,
		is_coupon,
		coupon_id, pay_status, `state`, create_id, create_time, update_id, update_time,
		is_individual,
		order_amount, discount_amount, pay_amount, apply_id
		, invoice_type , invoice_title, invoice_number, invoice_details,
		consignee_name
		, consignee_area, consignee_address, consignee_phone, payment_mode,
		third_party_no,bank_deposit,bank_number,remarks,email,invoice_state
	</sql>
	<select id="selectByPrimaryKey"
		parameterType="java.lang.Integer" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from fc_order
		where id = #{id,jdbcType=INTEGER}
	</select>

	<select id="selectByCode" parameterType="java.lang.String"
		resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from fc_order
		where code = #{code,jdbcType=INTEGER}
	</select>
	<insert id="insertSelective"
		parameterType="chinaPress.fc.order.model.FcOrder"
		useGeneratedKeys="true" keyProperty="id">
		insert into fc_order
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="date != null">
				`date`,
			</if>
			<if test="code != null">
				code,
			</if>
			<if test="roleType != null">
				role_type,
			</if>
			<if test="roleId != null">
				role_id,
			</if>
			<if test="courseId != null">
				course_id,
			</if>
			<if test="startTime != null">
				start_time,
			</if>
			<if test="endTime != null">
				end_time,
			</if>
			<if test="isCoupon != null">
				is_coupon,
			</if>
			<if test="couponId != null">
				coupon_id,
			</if>
			<if test="payStatus != null">
				pay_status,
			</if>
			<if test="state != null">
				`state`,
			</if>
			<if test="createId != null">
				create_id,
			</if>
			<if test="createTime != null">
				create_time,
			</if>
			<if test="updateId != null">
				update_id,
			</if>
			<if test="updateTime != null">
				update_time,
			</if>
			<if test="isIndividual != null">
				is_individual,
			</if>
			<if test="orderAmount != null">
				order_amount,
			</if>
			<if test="discountAmount != null">
				discount_amount,
			</if>
			<if test="payAmount != null">
				pay_amount,
			</if>
			<if test="applyId != null">
				apply_id,
			</if>
			<if test="invoiceType != null">invoice_type,</if>
			<if test="invoiceTitle != null">invoice_title,</if>
			<if test="invoiceNumber != null">invoice_number,</if>
			<if test="invoiceDetails != null">invoice_details,</if>
			<if test="consigneeName != null">consignee_name,</if>
			<if test="consigneeArea != null">consignee_area,</if>
			<if test="consigneeAddress != null">consignee_address,</if>
			<if test="consigneePhone != null">consignee_phone,</if>
			<if test="paymentMode != null">payment_mode,</if>
			<if test="thirdPartyNo != null">third_party_no,</if>
			<if test="bankDeposit != null">bank_deposit,</if>
			<if test="bankNumber != null">bank_number,</if>
			<if test="remarks != null">remarks,</if>
			<if test="email != null">email,</if>
			<if test="invoiceState !=null">invoice_state,</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=INTEGER},
			</if>
			<if test="date != null">
				#{date,jdbcType=DATE},
			</if>
			<if test="code != null">
				#{code,jdbcType=VARCHAR},
			</if>
			<if test="roleType != null">
				#{roleType,jdbcType=INTEGER},
			</if>
			<if test="roleId != null">
				#{roleId,jdbcType=INTEGER},
			</if>
			<if test="courseId != null">
				#{courseId,jdbcType=INTEGER},
			</if>
			<if test="startTime != null">
				#{startTime,jdbcType=TIMESTAMP},
			</if>
			<if test="endTime != null">
				#{endTime,jdbcType=TIMESTAMP},
			</if>
			<if test="isCoupon != null">
				#{isCoupon,jdbcType=INTEGER},
			</if>
			<if test="couponId != null">
				#{couponId,jdbcType=INTEGER},
			</if>
			<if test="payStatus != null">
				#{payStatus,jdbcType=INTEGER},
			</if>
			<if test="state != null">
				#{state,jdbcType=INTEGER},
			</if>
			<if test="createId != null">
				#{createId,jdbcType=INTEGER},
			</if>
			<if test="createTime != null">
				#{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="updateId != null">
				#{updateId,jdbcType=INTEGER},
			</if>
			<if test="updateTime != null">
				#{updateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="isIndividual != null">
				#{isIndividual},
			</if>
			<if test="orderAmount != null">
				#{orderAmount},
			</if>
			<if test="discountAmount != null">
				#{discountAmount},
			</if>
			<if test="payAmount != null">
				#{payAmount},
			</if>
			<if test="applyId != null">
				#{applyId},
			</if>
			<if test="invoiceType != null">#{invoiceType},</if>
			<if test="invoiceTitle != null">#{invoiceTitle},</if>
			<if test="invoiceNumber != null">#{invoiceNumber},</if>
			<if test="invoiceDetails != null">#{invoiceDetails},</if>
			<if test="consigneeName != null">#{consigneeName},</if>
			<if test="consigneeArea != null">#{consigneeArea},</if>
			<if test="consigneeAddress != null">#{consigneeAddress},</if>
			<if test="consigneePhone != null">#{consigneePhone},</if>
			<if test="paymentMode != null">#{paymentMode},</if>
			<if test="thirdPartyNo != null">#{thirdPartyNo},</if>
			<if test="bankDeposit != null">#{bankDeposit},</if>
			<if test="bankNumber != null">#{bankNumber},</if>
			<if test="remarks != null">#{remarks},</if>
			<if test="email != null">#{email},</if>
			<if test="invoiceState != null">#{invoiceState},</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective"
		parameterType="chinaPress.fc.order.model.FcOrder">
		update fc_order
		<set>
			<if test="date != null">
				`date` = #{date,jdbcType=DATE},
			</if>
			<if test="code != null">
				code = #{code,jdbcType=VARCHAR},
			</if>
			<if test="roleType != null">
				role_type = #{roleType,jdbcType=INTEGER},
			</if>
			<if test="roleId != null">
				role_id = #{roleId,jdbcType=INTEGER},
			</if>
			<if test="courseId != null">
				course_id = #{courseId,jdbcType=INTEGER},
			</if>
			<if test="startTime != null">
				start_time = #{startTime,jdbcType=TIMESTAMP},
			</if>
			<if test="endTime != null">
				end_time = #{endTime,jdbcType=TIMESTAMP},
			</if>
			<if test="isCoupon != null">
				is_coupon = #{isCoupon,jdbcType=INTEGER},
			</if>
			<if test="couponId != null">
				coupon_id = #{couponId,jdbcType=INTEGER},
			</if>
			<if test="payStatus != null">
				pay_status = #{payStatus,jdbcType=INTEGER},
			</if>
			<if test="state != null">
				`state` = #{state,jdbcType=INTEGER},
			</if>
			<if test="createId != null">
				create_id = #{createId,jdbcType=INTEGER},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="updateId != null">
				update_id = #{updateId,jdbcType=INTEGER},
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="isIndividual != null">
				is_individual = #{isIndividual},
			</if>
			<if test="orderAmount != null">
				order_amount = #{orderAmount},
			</if>
			<if test="discountAmount != null">
				discount_amount = #{discountAmount},
			</if>
			<if test="payAmount != null">
				pay_amount = #{payAmount},
			</if>
			<if test="applyId != null">
				#{applyId},
			</if>
			<if test="invoiceType != null">invoice_type = #{invoiceType},</if>
			<if test="invoiceTitle != null">invoice_title = #{invoiceTitle},</if>
			<if test="invoiceNumber != null">invoice_number = #{invoiceNumber},</if>
			<if test="invoiceDetails != null">invoice_details = #{invoiceDetails},</if>
			<if test="consigneeName != null">consignee_name = #{consigneeName},</if>
			<if test="consigneeArea != null">consignee_area = #{consigneeArea},</if>
			<if test="consigneeAddress != null">consignee_address = #{consigneeAddress},</if>
			<if test="consigneePhone != null">consignee_phone = #{consigneePhone},</if>
			<if test="paymentMode != null">payment_mode = #{paymentMode},</if>
			<if test="thirdPartyNo != null">third_party_no = #{thirdPartyNo},</if>
			<if test="bankDeposit != null">bank_deposit = #{bankDeposit},</if>
			<if test="bankNumber != null">bank_number = #{bankNumber},</if>
			<if test="remarks != null">remarks = #{remarks},</if>
			<if test="email != null">email = #{email},</if>
			<if test="invoiceState != null">invoice_state = #{invoiceState},</if>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>

	<!-- 终端 我的订单数据数量 -->
	<select id="findTerminalOrderCount" resultType="int"
		parameterType="chinaPress.fc.order.vo.TerminalOrderListParam">
		SELECT
			count(*)
		FROM
			fc_order a
		LEFT JOIN fc_course_archives b ON b.id = a.course_id
		<where>
			<if test="roleId != null">AND a.role_id = #{roleId} </if>
			<if test="roleType != null">AND a.role_type = #{roleType} </if>
			<if test="payStatus != null">AND a.pay_status = #{payStatus}</if>
			<if test="courseName != null and courseName != ''">AND b.`name` LIKE CONCAT('%', #{courseName}, '%')</if>
		</where>
	</select>

	<!-- 终端 我的订单数据集合 -->
	<select id="findTerminalOrderList"
		resultType="chinaPress.fc.order.vo.TerminalOrderListVo"
		parameterType="chinaPress.fc.order.vo.TerminalOrderListParam">
		SELECT
			a.id AS id,
			a.date,
			a.`code`,
			b.`name` AS courseName,
			b.course_price AS coursePrice,
			b.course_number AS courseNumber,
			a.pay_status AS payStatus,
			a.create_time createTime,
			a.pay_amount payAmount,
			b.photo courseCover
		FROM
			fc_order a
		LEFT JOIN fc_course_archives b ON b.id = a.course_id
		<where>
			<if test="roleId != null">AND a.role_id = #{roleId} </if>
			<if test="roleType != null">AND a.role_type = #{roleType} </if>
			<if test="payStatus != null">AND a.pay_status = #{payStatus}</if>
			<if test="courseName != null and courseName != ''">AND b.`name` LIKE CONCAT('%', #{courseName}, '%')</if>
		</where>
		ORDER BY a.date DESC
		<if test="pageNumber != null and pageSize != null">LIMIT #{offSet}, #{pageSize}</if>
	</select>

	<resultMap
		type="chinaPress.fc.order.vo.TerminalInstitutionOrderDetailVo"
		id="InstitutionOrderDetailResultMap">
		<id column="a_id" jdbcType="INTEGER" property="id" />
		<result column="a_code" jdbcType="VARCHAR" property="code" />
		<result column="a_course_id" jdbcType="INTEGER"
			property="courseId" />
		<result column="a_pay_status" jdbcType="INTEGER"
			property="payStatus" />
		<result column="a_start_time" jdbcType="TIMESTAMP"
			property="startTime" />
		<result column="a_end_time" jdbcType="TIMESTAMP"
			property="endTime" />
		<result column="c_name" jdbcType="VARCHAR"
			property="courseName" />
		<result column="c_course_price" jdbcType="DECIMAL"
			property="coursePrice" />
	</resultMap>

	<!-- 终端 机构我的订单详情 -->
	<select id="findTerminalInstitutionOrderDetail"
		resultMap="InstitutionOrderDetailResultMap">
		SELECT
			a.id AS a_id,
			a.course_id AS a_course_id,
			a.`code` AS a_code,
			a.pay_status AS a_pay_status,
			a.start_time AS a_start_time,
			a.end_time
			AS a_end_time,
			c.course_price AS c_course_price,
			c.course_number AS
			courseNumber,
			c.`name` AS c_name
		FROM
			fc_order a
		LEFT JOIN fc_course_archives c ON c.id = a.course_id
		WHERE a.id = #{id}
	</select>

	<!-- 终端家长 课程数据数量 -->
	<select id="findTerminalPractitionerCourseCount"
		resultType="int"
		parameterType="chinaPress.fc.order.vo.TerminalPractitionerOrderCourseListParam">
		SELECT 
			COUNT(*) 
		FROM (
			SELECT
				c.id,
				c.`name`,
				a.start_time AS startTime,
				a.end_time AS endTime,
				c.course_price AS coursePrice,
				b.total_count AS totalCount,
				b.have_count haveCount,
				IF( b.total_count = b.have_count, 1, 2 ) AS `status`
			FROM
				fc_order a
			INNER JOIN fc_order_person b ON b.order_id = a.id
			INNER JOIN fc_course_archives c ON c.id = a.course_id
			WHERE
				b.is_individual = 1
				<if test="roleId != null">AND b.role_id = #{roleId} </if>
				<if test="roleType != null">AND b.role_type = #{roleType} </if>
				<if test="courseName != null and courseName != ''">AND c.`name` LIKE CONCAT('%', #{courseName}, '%')</if>
		) AS parent_table
		<where>
			<if test="status != null">AND parent_table.`status` = #{status}</if>
		</where>
	</select>

	<!-- 终端家长 课程数据集合 -->
	<select id="findTerminalPractitionerCourseList"
		resultType="chinaPress.fc.order.vo.TerminalPractitionerOrderCourseListVo"
		parameterType="chinaPress.fc.order.vo.TerminalPractitionerOrderCourseListParam">
		SELECT
			c.id,
			c.`name`,
			c.photo,
			a.start_time AS startTime,
			a.end_time AS
			endTime,
			c.course_price AS coursePrice,
			b.total_count AS totalCount,
			b.have_count haveCount,
			IF( b.total_count = b.have_count, 2, 1 ) AS
			`status`
		FROM
			fc_order a
		INNER JOIN fc_order_person b ON b.order_id = a.id
		INNER JOIN fc_course_archives c ON c.id = a.course_id
		WHERE
			b.is_individual = 1
			AND a.pay_status = 2
			<if test="roleId != null">AND b.role_id = #{roleId} </if>
			<if test="roleType != null">AND b.role_type = #{roleType} </if>
			<if test="courseName != null and courseName != ''">AND c.`name` LIKE CONCAT('%', #{courseName}, '%')</if>
			<if test="status != null">HAVING `status` = #{status}</if>
			<if test="pageNumber != null and pageSize != null">LIMIT #{offSet}, #{pageSize}</if>
	</select>

	<!-- 查询课程是否拥有 -->
	<select id="findMyCourseIsExist" resultMap="BaseResultMap">
		SELECT
			a.*
		FROM
			fc_order a
		INNER JOIN fc_order_person b ON b.order_id = a.id
		INNER JOIN fc_course_archives c ON c.id = a.course_id
		WHERE
			b.is_individual = 1
			AND b.role_id = #{roleId}
			AND b.role_type = #{roleType}
			AND a.course_id = #{courseId}
		ORDER BY update_time DESC
		LIMIT 1
	</select>

	<!-- 终端支付订单详情 -->
	<select id="findTerminalPayOrderDetail"
		resultType="chinaPress.fc.order.vo.TerminalPayOrderDetailVo">
		SELECT
			a.id,
			a.`code`,
			a.pay_amount AS payAmount,
			b.id AS courseId,
			b.photo AS
			coursePhoto,
			b.`name` AS courseName,
			b.course_price AS coursePrice
		FROM
			fc_order a
		INNER JOIN fc_course_archives b ON b.id = a.course_id
		WHERE
			a.id = #{id}
	</select>

	<!-- 终端提交订单详情 -->
	<select id="findTerminalSubmitOrderDetail"
		resultType="chinaPress.fc.order.vo.TerminalSubmitOrderDetailVo">
		SELECT
			a.id,
			a.date,
			a.`code`,
			b.id AS courseId,
			b.photo AS coursePhoto,
			b.`name`
			AS courseName,
			b.course_price AS coursePrice,
			a.is_coupon AS isCoupon,
			c.id AS couponId,
			c.`code` AS couponCode,
			a.order_amount AS orderAmount,
			a.discount_amount AS discountAmount,
			a.pay_amount AS payAmount,
			a.invoice_type AS invoiceType,
			a.invoice_title AS invoiceTitle,
			a.invoice_number AS invoiceNumber,
			a.invoice_details AS invoiceDetails,
			a.consignee_name AS consigneeName,
			a.consignee_area AS consigneeArea,
			a.consignee_address AS consigneeAddress,
			a.consignee_phone AS consigneePhone,
			a.bank_deposit AS bankDeposit,
			a.bank_number AS bankNumber,
			a.remarks AS remarks,
			a.email AS email
		FROM
			fc_order a
		INNER JOIN fc_course_archives b ON b.id = a.course_id
		LEFT JOIN fc_discount_coupon_record c ON c.id = a.coupon_id
		WHERE
			a.id = #{id}
	</select>
	
	<!-- 判断当前这个课程当前报名人是否正在学习中 -->
	<select id="selectCourseIsLearning" resultMap="BaseResultMap">
		select
			a.*
		from
			fc_order a
		inner join fc_order_person b on a.id = b.order_id
		where
			a.course_id = #{courseId}
			and a.start_time <![CDATA[<=]]> now()
			and now() <![CDATA[<=]]> a.end_time
			and b.role_type = #{roleType}
			and b.role_id = #{roleId}
	</select>
	
	<!-- 终端审核和个人信息展示 查询条件：订单id，发票类型，是否已申请开发票，用户的角色id，用户的id-->
	<select id="selectInvoiceInfo" resultType="chinaPress.fc.order.vo.OrderInvoiceInfo">
	SELECT
		a.id,
		a.date,
		a. CODE,
		b. NAME,
		a.pay_amount as payAmount,
		(
			CASE
			WHEN a.invoice_type = 2 THEN
			'个人'
			WHEN a.invoice_type = 3 THEN
			'公司'
			ELSE
			''
			END
		) invoiceType,
		a.invoice_title as invoiceTitle,
		a.invoice_number as invoiceNumber,
		a.bank_deposit as bankDeposit,
		a.bank_number as bankNumber,
		a.remarks,
		a.email
	FROM
	fc_order a
	LEFT JOIN fc_course_archives b ON a.course_id = b.id
	WHERE
		a.pay_status = 2
		AND (a.invoice_type = 2 OR a.invoice_type = 3)
		<if test="invoiceState != null">
			AND a.invoice_state = #{invoiceState}
	    </if>
		<if test="id != null">
			AND a.id = #{id}
	    </if>
	    <if test="invoiceType != null">
			AND a.invoice_type = #{invoiceType}
	    </if>
	    <if test="roleType != null">
			AND a.role_type = #{roleType}
	    </if>
	    <if test="roleId != null">
			AND a.role_id = #{roleId}
	    </if>
	ORDER BY a.create_time
	<if test="page != null and limit !=null">
		limit #{page} , #{limit}
	</if>
	</select>
	
	<select id="selectInvoiceInfoCount" resultType="java.lang.Integer">
	SELECT
		count(*)
	FROM
	fc_order a
	LEFT JOIN fc_course_archives b ON a.course_id = b.id
	WHERE
		a.pay_status = 2
		AND (a.invoice_type = 2 OR a.invoice_type = 3)
		<if test="invoiceState != null">
			AND a.invoice_state = #{invoiceState}
	    </if>
		<if test="id != null">
			AND a.id = #{id}
	    </if>
	    <if test="invoiceType != null">
			AND a.invoice_type = #{invoiceType}
	    </if>
	    <if test="roleType != null">
			AND a.role_type = #{roleType}
	    </if>
	    <if test="roleId != null">
			AND a.role_id = #{roleId}
	    </if>
	</select>
	
	<!-- 查询用户的发票信息用于管理端展示 -->
	<select id="selectUserInvoices" parameterType="java.lang.Integer" resultType="chinaPress.fc.order.vo.UserInvoiceInfo">
		SELECT A.* FROM
			(SELECT
				a.id as id,
				a.update_time as updateTime,
				b. user_name as userName,
				a.pay_amount as payAmount,
				(
				CASE
				WHEN a.invoice_type = 2 THEN
				'个人'
				WHEN a.invoice_type = 3 THEN
				'公司'
				ELSE
				''
				END
				) invoiceType
			FROM
				fc_order a
			LEFT JOIN
				role_institution_archives b
			ON a.role_id = b.id
			WHERE
				a.pay_status = 2
				and a.role_type = 1
				and a.invoice_state = 1
				AND (a.invoice_type = 2 OR a.invoice_type = 3)
				<if test="type != null">
					AND a.invoice_type = #{type}
			    </if>
			union ALL
			SELECT
				a.id as id,
				a.update_time as updateTime,
				b. user_name as userName,
				a.pay_amount as payAmount,
				(
				CASE
				WHEN a.invoice_type = 2 THEN
				'个人'
				WHEN a.invoice_type = 3 THEN
				'公司'
				ELSE
				''
				END
				) invoiceType
			FROM
				fc_order a
			LEFT JOIN	
				role_practitioner_archives b
			ON a.role_id = b.id
			WHERE
				a.pay_status = 2
				and (a.role_type = 2 or a.role_type = 3)
				and a.invoice_state = 1
				AND (a.invoice_type = 2 OR a.invoice_type = 3)
				<if test="type != null">
					AND a.invoice_type = #{type}
			    </if>
		) AS A
		ORDER BY A.updateTime DESC
		LIMIT #{page} ,#{limit}    
	</select>
	
	<select id="selectUserInvoicesCount" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		select sum(a.count) from (
		SELECT
			count(*) AS count
		FROM
			fc_order a,
			role_institution_archives b
		WHERE
			a.pay_status = 2
			and a.role_type = 1
			and a.role_id = b.id
			and a.invoice_state = 1
			AND (a.invoice_type = 2 OR a.invoice_type = 3)
			<if test="type != null">
				AND a.invoice_type = #{type}
		    </if>
		union ALL
		SELECT
			count(*) as count
		FROM
			fc_order a,
			role_practitioner_archives b
		WHERE
			a.pay_status = 2
			and (a.role_type = 2 or a.role_type = 3)
			and a.role_id = b.id
			and a.invoice_state = 1
			AND (a.invoice_type = 2 OR a.invoice_type = 3)
			<if test="type != null">
				AND a.invoice_type = #{type}
		    </if>
		) as a
	</select>
	
	<!-- 发票详情信息  终端和管理端公用-->
	<select id="selectInvoicePage" resultType="chinaPress.fc.order.vo.OrderInvoiceInfo">
	SELECT
		a.id,
		a.date,
		a. CODE,
		b. NAME,
		a.pay_amount as payAmount,
		(
			CASE
			WHEN a.invoice_type = 2 THEN
			'个人'
			WHEN a.invoice_type = 3 THEN
			'公司'
			ELSE
			''
			END
		) invoiceType,
		a.invoice_title as invoiceTitle,
		a.invoice_number as invoiceNumber,
		a.bank_deposit as bankDeposit,
		a.bank_number as bankNumber,
		a.remarks,
		a.email
	FROM
	fc_order a
	LEFT JOIN fc_course_archives b ON a.course_id = b.id
	WHERE
		a.pay_status = 2
		AND (a.invoice_type = 2 OR a.invoice_type = 3)
		<if test="id != null">
			AND a.id = #{id}
	    </if>
	</select>
</mapper>